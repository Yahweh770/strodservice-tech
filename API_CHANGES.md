# Изменения API для поддержки многопользовательского режима

## Обзор

В текущей архитектуре приложение "Строд-Сервис Технолоджи" работает как десктопное приложение с локальной базой данных. Для поддержки многопользовательского режима необходимо внести изменения в API, чтобы обеспечить корректную работу в распределенной среде.

## Основные изменения API

### 1. Аутентификация и авторизация

#### Новые эндпоинты:
```
POST /auth/register - регистрация нового пользователя
POST /auth/login - аутентификация пользователя
POST /auth/refresh - обновление токена доступа
GET /auth/profile - получение профиля текущего пользователя
PUT /auth/profile - обновление профиля пользователя
POST /auth/logout - выход из системы
```

#### Изменения в существующих эндпоинтах:
- Все эндпоинты требуют аутентификации через JWT-токен
- Добавлена проверка прав доступа к ресурсам
- Введена поддержка ролевой модели

### 2. Управление пользователями (доступно только администраторам)

```
GET /users - список пользователей
POST /users - создание нового пользователя
GET /users/{user_id} - получение информации о пользователе
PUT /users/{user_id} - обновление информации о пользователе
DELETE /users/{user_id} - удаление пользователя
PUT /users/{user_id}/role - изменение роли пользователя
PUT /users/{user_id}/status - изменение статуса пользователя
```

### 3. Ролевая модель и права доступа

```
GET /roles - список доступных ролей
POST /roles - создание новой роли
PUT /roles/{role_id} - обновление роли
DELETE /roles/{role_id} - удаление роли
GET /permissions - список всех разрешений
```

### 4. Изменения в существующих модулях

#### ГПР (График производства работ)
```
GET /gpr - получить список графиков (теперь фильтруется по проектам, к которым у пользователя есть доступ)
POST /gpr - создать график (теперь проверяется право на создание в выбранном проекте)
GET /gpr/{id} - получить график (проверяется право доступа к проекту)
PUT /gpr/{id} - обновить график (проверяется право на редактирование)
DELETE /gpr/{id} - удалить график (проверяется право на удаление)
```

#### Управление проектами
```
GET /projects - получить список проектов (только доступные пользователю)
POST /projects - создать проект (только для пользователей с правами создания проектов)
GET /projects/{id} - получить проект (проверяется право доступа)
PUT /projects/{id} - обновить проект (проверяется право на редактирование)
DELETE /projects/{id} - удалить проект (проверяется право на удаление)
GET /projects/{id}/access - получить список пользователей с доступом к проекту
POST /projects/{id}/access - предоставить доступ пользователю к проекту
DELETE /projects/{id}/access/{user_id} - отозвать доступ пользователя к проекту
```

#### Документооборот
```
GET /documents - получить список документов (только доступные пользователю)
POST /documents - загрузить документ (проверяется право на загрузку в выбранный проект)
GET /documents/{id} - получить документ (проверяется право доступа)
PUT /documents/{id} - обновить документ (проверяется право на редактирование)
DELETE /documents/{id} - удалить документ (проверяется право на удаление)
GET /documents/{id}/download - скачать документ (проверяется право доступа)
POST /documents/{id}/share - поделиться документом с другим пользователем
```

#### Материалы
```
GET /materials - получить список материалов (только доступные пользователю)
POST /materials - создать запись о материале (проверяется право на создание)
GET /materials/{id} - получить информацию о материале (проверяется право доступа)
PUT /materials/{id} - обновить информацию о материале (проверяется право на редактирование)
DELETE /materials/{id} - удалить запись о материале (проверяется право на удаление)
POST /materials/{id}/reserve - зарезервировать материалы (проверяется право на резервирование)
POST /materials/{id}/unreserve - отменить резервирование материалов
```

#### Замечания от строительного контроля
```
GET /construction-remarks - получить список замечаний (только доступные пользователю)
POST /construction-remarks - создать замечание (проверяется право на создание)
GET /construction-remarks/{id} - получить замечание (проверяется право доступа)
PUT /construction-remarks/{id} - обновить замечание (проверяется право на редактирование)
DELETE /construction-remarks/{id} - удалить замечание (проверяется право на удаление)
POST /construction-remarks/{id}/status - изменить статус замечания
POST /construction-remarks/{id}/assign - назначить ответственного за исправление
```

### 5. Новые эндпоинты для синхронизации и уведомлений

```
WS /ws/{user_id} - WebSocket-соединение для получения уведомлений
GET /notifications - получить список уведомлений пользователя
POST /notifications/read - отметить уведомления как прочитанные
GET /activity-log - получить журнал действий (аудит)
GET /online-users - получить список онлайн пользователей
```

## Примеры запросов

### Аутентификация
```javascript
// Логин
fetch('/auth/login', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    username: 'john_doe',
    password: 'secure_password'
  })
})
.then(response => response.json())
.then(data => {
  localStorage.setItem('access_token', data.access_token);
  localStorage.setItem('refresh_token', data.refresh_token);
});
```

### Получение списка проектов с фильтрацией по правам доступа
```javascript
// Получение проектов
fetch('/projects', {
  method: 'GET',
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
  }
})
.then(response => response.json())
.then(projects => {
  // Отображение только тех проектов, к которым у пользователя есть доступ
  displayProjects(projects);
});
```

### Создание нового проекта с проверкой прав
```javascript
// Создание проекта
fetch('/projects', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
  },
  body: JSON.stringify({
    name: 'Новый строительный объект',
    description: 'Проект жилого комплекса',
    contract_date: '2024-01-15',
    asphalt_date: '2024-06-01',
    start_date: '2024-02-01',
    end_date: '2024-12-31',
    status: 'active'
  })
})
.then(response => {
  if (response.status === 403) {
    alert('У вас недостаточно прав для создания проектов');
  } else if (response.ok) {
    return response.json();
  }
})
.then(project => {
  console.log('Проект успешно создан:', project);
});
```

## Изменения в структуре ответов

### Добавление информации о владельце и правах доступа
```json
{
  "id": 1,
  "name": "Проект A",
  "owner": {
    "id": 1,
    "username": "project_manager",
    "full_name": "Иван Петров"
  },
  "permissions": {
    "can_read": true,
    "can_write": true,
    "can_delete": false
  },
  "created_at": "2024-01-15T10:30:00Z",
  "updated_at": "2024-01-15T10:30:00Z"
}
```

### Структура объекта пользователя
```json
{
  "id": 1,
  "username": "john_doe",
  "email": "john@example.com",
  "full_name": "Джон Доу",
  "position": "Инженер ПТО",
  "department": "Производственно-технический отдел",
  "is_active": true,
  "is_admin": false,
  "role": "engineer_pto",
  "permissions": {
    "admin": false,
    "manage_users": false,
    "manage_documents": true,
    "manage_materials": true,
    "manage_projects": false
  },
  "created_at": "2024-01-01T00:00:00Z",
  "last_login": "2024-01-15T08:30:00Z"
}
```

## Обработка ошибок

Все эндпоинты теперь возвращают стандартизированные ошибки:

```json
{
  "detail": "У вас недостаточно прав для выполнения этого действия",
  "error_code": "INSUFFICIENT_PERMISSIONS",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

## Миграция данных

При переходе к многопользовательскому режиму потребуется:
1. Конвертировать существующую SQLite базу в PostgreSQL
2. Добавить поля для связи с пользователями
3. Назначить права доступа к существующим данным
4. Создать системного администратора

## Безопасность

- Все запросы должны содержать валидный JWT-токен
- Проверка прав доступа к каждому ресурсу
- Логирование всех действий пользователей
- Защита от CSRF и XSS атак
- Ограничение частоты запросов (rate limiting)